box: wercker/python
build:
    steps:
        - virtualenv:
            name: setup virtual environment
            install_wheel: true
        - pip-install
        - script:
            name: echo python information
            code: |
                echo "python version $(python --version) running"
                echo "pip version $(pip --version) running"
                pip freeze
        - script:
            name: running tests
            code: |
                echo "test script goes here"

deploy:
    steps:
        - add-to-known_hosts:
            hostname: imods.wunderkind.us
            fingerprint: 8c:2d:c2:d3:13:10:79:47:45:c3:da:60:5e:12:b1:14
        - mktemp:
            envvar: PRIVATEKEY_PATH
        - mktemp:
            envvar: SSH_CONFIG_PATH
        - mktemp:
            envvar: DEPLOY_TARBALL_PATH
        - create-file:
            name: write private key
            filename: $PRIVATEKEY_PATH
            content: $DEPLOY_PRIVATE
            overwrite: true
            hide-from-log: true
        - create-file:
            name: create temporary ssh config
            filename: $SSH_CONFIG_PATH
            content: $SSH_CONFIG_CONTENT
            overwrite: true
            hide-from-log: true
        #- script:
            #name: init environment variables
            #code: |
                #echo = PRIVATEKEY_PATH:
                #echo $PRIVATEKEY_PATH
                #echo = SSH_CONFIG_PATH:
                #echo $SSH_CONFIG_PATH
                #echo = SSH_HOSTNAME:
                #echo $SSH_HOSTNAME
                #echo = SSH_STOP_APP_CMD:
                #echo $SSH_STOP_APP_CMD
                #echo = SSH_START_APP_CMD:
                #echo $SSH_START_APP_CMD
                #echo = DEPLOY_TARBALL_PATH:
                #echo $DEPLOY_TARBALL_PATH
                #echo = DEPLOY_REMOTE_DIR:
                #echo $DEPLOY_REMOTE_DIR
                #echo = DEPLOY_PACKAGE_DIR:
                #echo $DEPLOY_PACKAGE_DIR

        - script:
            name: packaging application
            code: tar zcv $WERCKER_SOURCE_DIR/* -f $DEPLOY_TARBALL_PATH

        - script:
            name: transfer application
            code: |
                echo PWD=$PWD
                echo ================================================
                ls -al
                echo ================================================
                scp -i $PRIVATEKEY_PATH -F $SSH_CONFIG_PATH $DEPLOY_TARBALL_PATH $SSH_HOSTNAME

        - script:
            name: stopping application
            code: ssh -i $PRIVATEKEY_PATH -F $SSH_CONFIG_PATH $SSH_HOSTNAME pkill -9 uwsgi

        - script:
            name: cleanning remote environment
            code: ssh -i $PRIVATEKEY_PATH -F SSH_CONFIG_PATH rm -rf ~/app/*

        - script:
            name: unpacking application
            code: |
                ssh -i $PRIVATEKEY_PATH -F $SSH_CONFIG_PATH $SSH_HOSTNAME tar zxvf ~/`basename $DEPLOY_TARBALL_PATH`

        - script:
            name: starting application
            code: ssh -i $PRIVATEKEY_PATH -F $SSH_CONFIG_PATH $SSH_HOSTNAME uwsgi --init=~/app/uwsgi.ini
